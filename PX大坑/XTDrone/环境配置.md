# 环境配置

使用ubuntu20.04 + PX4 1.13版本，在完成ros+anaconda配置之后进行


官方文档： https://www.yuque.com/xtdrone/manual_cn/basic_config_13


### 依赖安装

可以先跳过，后面等缺少依赖报错了再添加，暂时没有遇到问题

### Gazebo安装

不需要卸载gazebo，ros-noetic自带的就是gazebo11，不用卸载直接用就行。

暂时也不用源码编译Gazebo的ROS插件，官方文档这里只是把gazebo插件源码拿来编译了一下，还没修改。先用着二进制安装的Gazebo的ROS插件，等后面需要修改了再回来源码编译，source一下环境就覆盖了。

gazebo的models文件需要自行下载，会用到。

### MAVROS安装
正常安装即可

### PX4配置

按照我的文档里面，完成源码编译固件和官方的gazebo classic 仿真即可

然后可以看一下XTDrone这里的步骤进行一下验证。

注意XTDrone这里把PX4源码文件夹该了个名字，可以不改

    mv PX4-Autopilot PX4_Firmware

然后修改 ~/.bashrc，加入以下代码,注意路径匹配，前两个source顺序不能颠倒。注意我这里PX4-Autopilot没改名，这个应该是PX4源码

    # source了catkin_ws的路径，这个工作空间就是前面用来编译gazebo的ros插件的（暂时可以用官方的插件），暂时没用。
    source ~/catkin_ws/devel/setup.bash
    # 这里调用了PX4官方的一个bash文件，里面添加了一些gazebo模型的路径和库的路径，后面两个参数就要使用的路径
    source ~/PX4-Autopilot/Tools/setup_gazebo.bash ~/PX4-Autopilot/ ~/PX4-Autopilot/build/px4_sitl_default
    # 将PX4-Autopilot作为功能包添加到环境中去，注意PX4-Autopilot里面的"package.xml" 文件，这是ros功能包的描述文件，它把功能包起名为了"px4"，所以后面就可以用roscd px4来直接进入PX4-Autopilot文件夹
    export ROS_PACKAGE_PATH=$ROS_PACKAGE_PATH:~/PX4-Autopilot
    # 同上
    export ROS_PACKAGE_PATH=$ROS_PACKAGE_PATH:~/PX4-Autopilot/Tools/sitl_gazebo


### XTDrone源码下载

这一步将XTDrone源码里面的一些文件拷贝到了PX4-Autopilot源码里面去了，主要是

* 修改启动脚本文件。把UDP端口号给改了
* 添加launch文件
* 添加世界文件
* 修改部分插件 关于gimbal_controller和wind_plugin的插件
* 修改部分模型文件
* 删除了.gazebo/models/里面与PX4-Autopilot里面的同名模型文件

因为Gazebo寻找模型的顺序，是先在~/.gazebo/models/下寻找，然后在其他路径寻找，所以在往PX4 SITL复制models时，要注意~/.gazebo/models/下有没有同名文件（比如~/.gazebo/models/下默认有stereo_camera），有的话要么将该同名文件删去，要么替换该同名文件。如果在仿真过程中出现了某个部件为白色方块的情况，大概率是因为~/.gazebo/models/下有和PX4_Firmware/Tools/sitl_gazebo/models重复的模型，此时删掉~/.gazebo/models/下的模型文件即可

**注意**插件修改涉及到CPP文件，需要删除之前编译的重新编译

### roslaunch indoor1.launch 报错

Spawn service failed

修改对应的launch文件中调用的world文件，将其中的`sim_time`修改为0。

例如indoor1.launch，也就需要打开该launch文件，然后找到他调用的indoor1.world文件，将其中的sim_time修改为0

https://zhuanlan.zhihu.com/p/623246409

# hector-slam

注意 roslaunch px4 indoor3.launch 其实并没有发布任何关于无人机坐标系的东西（不像xacro文件的gazebo仿真，直接用robot_state_publisher和robot_joint_publisher发布了机器人各个关节之间的TF）

这里作者给的hectorslam使用了IMU

hector_slam_xtdrone.launch 启动了三个文件

    mapping_xtdrone.rviz
    hector_imu_xtdrone.launch
    hector_mapping_xtdrone.launch

hector_imu_xtdrone.launch 订阅了IMU数据，并发布了从base_link到base_stabilized的TF。而且在文件的一开始，发布了雷达坐标系到base_link的静态坐标变换。

hector_mapping_xtdrone.launch 订阅了激光数据，发布了map odom的静态坐标变化，因为hector实际上没有odom（与gmapping不同）

可能遇到的**Bug**

1、gazebo中激光雷达显示正常，但是没有/scan这个话题

插件没装好，因为我之前按照教程卸载过gazebo

    sudo apt-get install ros-noetic-gazebo-plugins

2、TF树断开了，运行hector-slam没有地图，rviz中单独查看laserscan消息报错说iris_0/laser_2d坐标系不存在

hector_imu_xtdrone.launch的第一行，雷达坐标系是错误的

```xml
  <node pkg="tf" type="static_transform_publisher" name="base_to_laser_broadcaster" args="0 0 0 0 0 0 base_link iris_0/laser_2d 100" />
```

应该为/laser_2d

可以去雷达的sdf文件中看一下framename，也可以直接rostopic echo "激光消息"，发现激光topic的header的frame是"laser_2d"，而不是iris_0/laser_2d 100


# orb-slam2

